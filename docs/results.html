<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title data-i18n="resultsTitle2">Results</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">integrated Digit-in-Noise Test</div>
    <div class="lang-switch" style="margin-left:auto;">
      <label for="uiLang" data-i18n="languageLabel">Language</label>
      <select id="uiLang">
        <option value="english">English</option>
        <option value="mandarin">普通话</option>
      </select>
    </div>
  </header>

  <main class="container stack" style="max-width: 960px;">
    <h1 id="pageTitle" class="large-title" data-i18n="resultsTitle2">Results</h1>

    <!-- Per-condition metrics -->
    <section id="condWrap" style="display:none;">
      <h2 data-i18n="perCondMetrics">Per-condition metrics</h2>
      <div class="spacer-xs"></div>
      <table class="table" id="condTable">
        <thead>
          <tr>
            <th data-i18n="thCondition">Condition</th>
            <th data-i18n="thSRT">SRT (dB)</th>
            <th data-i18n="thRTAll">RT (all) ms</th>
            <th data-i18n="thRTCorrect">RT (correct) ms</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="noCondsMsg" class="note" style="display:none;" data-i18n="noCond">
        No condition results to show.
      </p>
    </section>

    <!-- Differences -->
    <section id="diffWrap" style="display:none;">
      <h2 data-i18n="diffsTitle">Differences</h2>
      <div class="spacer-xs"></div>
      <table class="table" id="diffTable">
        <thead>
          <tr><th>Metric</th><th>Value</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="noDiffsMsg" class="note" style="display:none;" data-i18n="noDiff">
        No differences to show.
      </p>
    </section>

    <div class="spacer-md"></div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button id="downloadJson" class="secondary" data-i18n="dlJson">Download JSON</button>
      <button id="downloadCsv" class="secondary" data-i18n="dlCsv">Download CSV (trials)</button>
      <button id="returnHome" class="primary" data-i18n="returnHome">Return Home</button>
    </div>
  </main>

  <!-- ★ 改成你的 Render 域名 -->
  <script>window.API_BASE = 'https://din-backend-h4a3.onrender.com';</script>

  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // language init
      const uiLangSel = document.getElementById('uiLang');
      const savedUILang = localStorage.getItem('uiLang') || 'english';
      uiLangSel.value = savedUILang;
      if (typeof setUILanguage === 'function') setUILanguage(savedUILang);
      uiLangSel.addEventListener('change', () => {
        localStorage.setItem('uiLang', uiLangSel.value);
        if (typeof setUILanguage === 'function') setUILanguage(uiLangSel.value);
      });

      // compute results
      const results = (typeof finalizeAndGetResults === 'function')
        ? finalizeAndGetResults()
        : { condResults:{}, summary:{}, trials:[] };

      const condResults = results.condResults || {};
      const summary = results.summary || {};

      // render per-condition
      const condRows = [];
      for (const cond of Object.keys(condResults)) {
        const r = condResults[cond];
        const hasAny = r && (r.SRT != null || r.RT_all_mean_ms != null || r.RT_correct_mean_ms != null);
        if (!hasAny) continue;
        condRows.push(`
          <tr>
            <td>${cond}</td>
            <td>${r.SRT != null ? r.SRT : ''}</td>
            <td>${r.RT_all_mean_ms != null ? r.RT_all_mean_ms : ''}</td>
            <td>${r.RT_correct_mean_ms != null ? r.RT_correct_mean_ms : ''}</td>
          </tr>`);
      }
      if (condRows.length) {
        document.querySelector('#condTable tbody').innerHTML = condRows.join('');
        document.getElementById('condWrap').style.display = '';
      } else {
        document.getElementById('noCondsMsg').style.display = '';
      }

      // render diffs
      const diffMap = {
        SRT3b_3: 'SRT(3b) − SRT(3f)',
        SRT2b_2: 'SRT(2b) − SRT(2f)',
        SRT5_3:  'SRT(5f) − SRT(3f)',
        SRT5_2:  'SRT(5f) − SRT(2f)',
        RT3b_3:  'RT(correct, 3b) − RT(correct, 3f)',
        RT2b_2:  'RT(correct, 2b) − RT(correct, 2f)',
        RT5_3:   'RT(correct, 5f) − RT(correct, 3f)',
        RT5_2:   'RT(correct, 5f) − RT(correct, 2f)'
      };
      const diffRows = [];
      for (const k of Object.keys(diffMap)) {
        const v = summary[k];
        if (v == null) continue;
        diffRows.push(`<tr><td>${diffMap[k]}</td><td>${v}</td></tr>`);
      }
      if (diffRows.length) {
        document.querySelector('#diffTable tbody').innerHTML = diffRows.join('');
        document.getElementById('diffWrap').style.display = '';
      } else {
        document.getElementById('noDiffsMsg').style.display = '';
      }

      // ---- upload full payload to server (non-blocking) ----
      (async function uploadResults(){
        const titleEl = document.getElementById('pageTitle');
        let badge = document.getElementById('uploadStatus');
        if (!badge) {
          badge = document.createElement('div');
          badge.id = 'uploadStatus';
          badge.className = 'note';
          badge.style.marginTop = '6px';
          titleEl && titleEl.insertAdjacentElement('afterend', badge);
        }

        const din = JSON.parse(localStorage.getItem('din_session') || '{}');
        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
        const uiLang = localStorage.getItem('uiLang') || 'english';
        const fixedNoiseGain = parseFloat(localStorage.getItem('fixedNoiseGain') || '1');

        // perCondition array
        const perCondition = Object.entries(condResults).map(([condition, r]) => {
          const def = (window.COND_DEFS && window.COND_DEFS[condition]) || {};
          return {
            condition,
            nDigits: def.nDigits || null,
            SRT: (r && r.SRT != null) ? r.SRT : null,
            RT_all_ms: (r && r.RT_all_mean_ms != null) ? r.RT_all_mean_ms : null,
            RT_correct_ms: (r && r.RT_correct_mean_ms != null) ? r.RT_correct_mean_ms : null
          };
        });

        // SNR tracks
        const snrTracks = {};
        if (din.presentedSNRs || din.effectiveSNRs) {
          const conds = new Set([
            ...(Object.keys(din.presentedSNRs || {})),
            ...(Object.keys(din.effectiveSNRs || {}))
          ]);
          conds.forEach(c => {
            snrTracks[c] = {
              presented: (din.presentedSNRs && din.presentedSNRs[c]) || [],
              effective: (din.effectiveSNRs && din.effectiveSNRs[c]) || []
            };
          });
        }

        const trials = Array.isArray(din.trials) ? din.trials : (results.trials || []);

        const meta = {
          appVersion: window.APP_VERSION || 'v1',
          uiLang,
          stimLang: userInfo.stimLang,
          fixedNoiseGain: isFinite(fixedNoiseGain) ? fixedNoiseGain : null,
          conditionOrder: din.conditionOrder || userInfo.testConditions || [],
          phase: din.phase || null,
          practiceIdx: din.practiceIdx || null,
          formalIdx: din.formalIdx || null
        };

        const payload = {
          sessionId: din.sessionId || din._id || `s_${Date.now()}`,
          participantId: userInfo.pid || '',
          userInfo,
          perCondition,
          diffs: results.summary || {},
          snrTracks,
          trials,
          meta,
          createdAt: new Date().toISOString()
        };

        try {
          const res = await fetch('/api/results', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();
          console.log('Results uploaded:', data);
          if (badge) badge.textContent = 'Saved to server.';
        } catch (e) {
          console.warn('Upload failed', e);
          if (badge) badge.textContent = 'Local only (server save failed).';
        }
      })();

      // downloads / return
      document.getElementById('downloadJson').addEventListener('click', () => {
        if (typeof downloadJSON === 'function') {
          downloadJSON(results, `din_results_${Date.now()}.json`);
        } else {
          const blob = new Blob([JSON.stringify(results, null, 2)], { type:'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `din_results_${Date.now()}.json`;
          a.click();
        }
      });

      document.getElementById('downloadCsv').addEventListener('click', () => {
        const trials = results.trials || (JSON.parse(localStorage.getItem('din_session')||'{}').trials) || [];
        if (typeof downloadCSV === 'function') {
          downloadCSV(trials, `din_trials_${Date.now()}.csv`);
        } else {
          const headers = [
            "participantId","condition","nDigits","digitsPresented",
            "presentedSNR","effectiveSNR","response","correct","rt_ms","timestamp"
          ];
          const rows = [headers.join(",")].concat(
            trials.map(t => headers.map(h => JSON.stringify(t[h] ?? "")).join(","))
          );
          const blob = new Blob([rows.join("\n")], { type:"text/csv" });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `din_trials_${Date.now()}.csv`;
          a.click();
        }
      });

      document.getElementById('returnHome').addEventListener('click', () => {
        // localStorage.removeItem('din_session'); // 可选：清会话
        location.href = 'index.html';
      });
    });
  </script>
</body>
</html>

