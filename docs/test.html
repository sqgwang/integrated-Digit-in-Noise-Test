<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>iDIN Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">integrated Digit-in-Noise Test</div>
    <div class="lang-switch">
      <select id="uiLang">
        <option value="english">English</option>
        <option value="mandarin">普通话</option>
      </select>
    </div>
  </header>

  <main class="container test-page">
    <h2 id="condTitle" data-i18n="condTitle">Condition</h2>
    <p id="condText"></p>

    <div class="progress-row">
      <div id="progress">Trial 0/0</div>
      <div id="statusMsg" class="note"></div>
    </div>

    <div class="audiocontrol center">
      <button id="playTrial" class="primary" data-i18n="play">Play</button>
      <div id="playHint" class="note" data-i18n="playHint">After playback, type the digits and press OK.</div>
    </div>

    <div class="display center">
      <div id="input" class="display-box"></div>
    </div>

    <div class="keypad center" id="keypad">
      <div class="kp-row">
        <button class="keypad-button" data-val="1">1</button>
        <button class="keypad-button" data-val="2">2</button>
        <button class="keypad-button" data-val="3">3</button>
      </div>
      <div class="kp-row">
        <button class="keypad-button" data-val="4">4</button>
        <button class="keypad-button" data-val="5">5</button>
        <button class="keypad-button" data-val="6">6</button>
      </div>
      <div class="kp-row">
        <button class="keypad-button" data-val="7">7</button>
        <button class="keypad-button" data-val="8">8</button>
        <button class="keypad-button" data-val="9">9</button>
      </div>
      <div class="kp-row">
        <button class="keypad-button" id="clear"
                data-i18n-title="backspace" title="Backspace"
                aria-label="Backspace" type="button">
          <svg viewBox="0 0 48 48" aria-hidden="true" focusable="false"
               stroke="currentColor" fill="none" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <!-- 键帽外形（圆角楔形） -->
            <path d="M20 10h18a4 4 0 0 1 4 4v20a4 4 0 0 1-4 4H20L8 24 20 10Z"></path>
            <!-- 删除的 X -->
            <path d="M27 19l10 10M37 19l-10 10"></path>
          </svg>
        </button>
        <button class="keypad-button" data-val="0">0</button>
        <button id="ok" class="keypad-button primary" data-i18n="ok">OK</button>
      </div>
    </div>

    <div class="center">
      <button id="nextConditionBtn" style="display:none;" data-i18n="nextCond">Next Condition</button>
    </div>
  </main>

  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const sel = document.getElementById('uiLang');
      sel.value = localStorage.getItem('uiLang') || 'english';
      sel.addEventListener('change', () => { localStorage.setItem('uiLang', sel.value); setUILanguage(sel.value); });
      setUILanguage(sel.value);

      // prepare UI
      const keypad = document.getElementById('keypad');
      keypad.addEventListener('click', (e) => {
        const b = e.target.closest('button');
        if (!b) return;
        if (b.id === 'clear') {
          clearInput();
          return;
        }
        if (b.id === 'ok') {
          submitInput();
          return;
        }
        const v = b.dataset.val;
        if (!v) return;
        appendInput(v);
      });

      document.getElementById('playTrial').addEventListener('click', async () => {
        // calling startTrialPlay which is in app.js
        document.getElementById('statusMsg').textContent = '';
        await startTrialPlay(); // render and play; returns when play finished and input enabled
      });

      document.getElementById('nextConditionBtn').addEventListener('click', () => {
        proceedToNextCondition();
      });

      // auto-start condition intro (showConditionIntro in app.js)
      showConditionIntro();
    });
  </script>
</body>
<script>
(function(){
  const btn = document.getElementById('clear');
  if (!btn) return;

  // 我们希望按钮里只有一个 SVG，绝不出现“⌫”等文本
  const svgMarkup =
    '<svg viewBox="0 0 48 48" aria-hidden="true" focusable="false" ' +
    'stroke="currentColor" fill="none" stroke-width="2" ' +
    'stroke-linecap="round" stroke-linejoin="round">' +
      '<path d="M20 10h18a4 4 0 0 1 4 4v20a4 4 0 0 1-4 4H20L8 24 20 10Z"></path>' +
      '<path d="M27 19l10 10M37 19l-10 10"></path>' +
    '</svg>';

  function lockToSVG() {
    // 1) 删除一切非 SVG 的子节点（含“⌫”文本）
    [...btn.childNodes].forEach(n => {
      const isSvg = (n.nodeType === 1 && n.tagName.toLowerCase() === 'svg');
      const isMeaningfulText = (n.nodeType === 3 && n.textContent.trim().length);
      if (!isSvg && isMeaningfulText) n.remove();
    });
    // 2) 如果没有 SVG，插入一个
    if (!btn.querySelector('svg')) btn.innerHTML = svgMarkup;
  }

  // 初次执行
  lockToSVG();

  // 任何后续对按钮的修改（例如某脚本又塞回“⌫”）都会被立刻清理
  const mo = new MutationObserver(lockToSVG);
  mo.observe(btn, { childList: true, characterData: true });

  // 语言切换后也再锁一次（有些 i18n 会重写内容）
  if (typeof window.setUILanguage === 'function') {
    const orig = window.setUILanguage;
    window.setUILanguage = function(lang){
      orig(lang);
      lockToSVG();
    };
  }
})();
</script>

</html>

<script>
(function(){
  const btn = document.getElementById('clear');
  if (!btn) return;

  // 我们希望按钮里只有一个 SVG，绝不出现“⌫”等文本
  const svgMarkup =
    '<svg viewBox="0 0 48 48" aria-hidden="true" focusable="false" ' +
    'stroke="currentColor" fill="none" stroke-width="2" ' +
    'stroke-linecap="round" stroke-linejoin="round">' +
      '<path d="M20 10h18a4 4 0 0 1 4 4v20a4 4 0 0 1-4 4H20L8 24 20 10Z"></path>' +
      '<path d="M27 19l10 10M37 19l-10 10"></path>' +
    '</svg>';

  function lockToSVG() {
    // 1) 删除一切非 SVG 的子节点（含“⌫”文本）
    [...btn.childNodes].forEach(n => {
      const isSvg = (n.nodeType === 1 && n.tagName.toLowerCase() === 'svg');
      const isMeaningfulText = (n.nodeType === 3 && n.textContent.trim().length);
      if (!isSvg && isMeaningfulText) n.remove();
    });
    // 2) 如果没有 SVG，插入一个
    if (!btn.querySelector('svg')) btn.innerHTML = svgMarkup;
  }

  // 初次执行
  lockToSVG();

  // 任何后续对按钮的修改（例如某脚本又塞回“⌫”）都会被立刻清理
  const mo = new MutationObserver(lockToSVG);
  mo.observe(btn, { childList: true, characterData: true });

  // 语言切换后也再锁一次（有些 i18n 会重写内容）
  if (typeof window.setUILanguage === 'function') {
    const orig = window.setUILanguage;
    window.setUILanguage = function(lang){
      orig(lang);
      lockToSVG();
    };
  }
})();
</script>
